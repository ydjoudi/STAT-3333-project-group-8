---
title: "Final Project"
author: "Youcef Djoudi"
date: "2025-10-25"
output:
  html_document:
    df_print: paged
  word_document: default
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)#
```


# PHASE 1: Exploratory Data Analysis (EDA)
Summary statistics for all numeric variables (mean, median, standard deviation)

```{r}
data <- read.csv("Sleep_health_and_lifestyle_dataset.csv")
head(data)
summary(data)



```


#Histograms for Sleep Duration, Stress Level, and Physical Activity Level.Boxplots comparing Sleep Duration and Quality of Sleep by Gender, BMI Category, and Sleep Disorder


```{r}
# Clean names so you don't need backticks
library(janitor)
dat <- clean_names(data)

# Quick EDA
hist(dat$sleep_duration, main="Distribution of Sleep Duration", xlab="Hours")

# Boxplots 
boxplot(sleep_duration ~ gender, data = dat,
        main="Sleep Duration by Gender", xlab="Gender", ylab="Hours")

boxplot(quality_of_sleep ~ sleep_disorder, data = dat,
        main="Sleep Quality by Sleep Disorder", xlab="Sleep Disorder", ylab="Quality (1â€“10)")

# Correlations (numeric only)
nums <- dat[, c("sleep_duration","quality_of_sleep","physical_activity_level",
                "stress_level","age","heart_rate","daily_steps")]
round(cor(nums), 2)



```


### PHASE 2
```{r}
# PHASE 2
library(readr)
library(janitor)
library(dplyr)
library(ggplot2)


data <- read.csv("Sleep_health_and_lifestyle_dataset.csv")
dat  <- clean_names(data)

set.seed(123)
B <- 10000

#### 2.1 Bootstrap 95% CIs: Mean Sleep Duration by Stress Level ####

stress_levels <- sort(unique(dat$stress_level))

boot_means_stress <- lapply(stress_levels, function(s) {
  x <- dat$sleep_duration[dat$stress_level == s]
  replicate(B, mean(sample(x, replace = TRUE)))
})

ci_stress <- data.frame(
  stress_level = stress_levels,
  mean_boot    = sapply(boot_means_stress, mean),
  ci_low       = sapply(boot_means_stress, quantile, 0.025),
  ci_high      = sapply(boot_means_stress, quantile, 0.975)
)

ci_stress
```
The bootstrap results show a clear pattern: higher stress levels are associated with lower average sleep duration. The lowest-stress group in the dataset (stress level 3) has a mean a little above 8.2 hours, while the highest groups (7 and 8) fall between about 6.0 and 6.5 hours. The confidence intervals for each stress level are narrow, which means the estimates are stable and the differences between levels are not due to randomness. The bootstrap histograms for each stress group show smooth and centered sampling distributions, which indicates the bootstrap procedure worked properly for estimating the mean within each group.
```{r}
# Plot: bootstrap distributions of mean Sleep Duration by Stress Level
boot_stress_df <- data.frame(
  stress_level = factor(rep(stress_levels, each = B)),
  boot_mean    = unlist(boot_means_stress)
)

ggplot(boot_stress_df, aes(x = boot_mean)) +
  geom_histogram(bins = 30) +
  facet_wrap(~ stress_level, scales = "free") +
  labs(
    title = "Bootstrap Distributions of Mean Sleep Duration by Stress Level",
    x = "Bootstrap Mean Sleep Duration (hours)",
    y = "Frequency"
  )

#### 2.2 Bootstrap 95% CI: Difference in Mean Sleep Duration (Male - Female) ####

male_sleep   <- dat$sleep_duration[dat$gender == "Male"]
female_sleep <- dat$sleep_duration[dat$gender == "Female"]

boot_diff <- replicate(B, {
  m_mean <- mean(sample(male_sleep,   replace = TRUE))
  f_mean <- mean(sample(female_sleep, replace = TRUE))
  m_mean - f_mean
})

obs_diff <- mean(male_sleep) - mean(female_sleep)
ci_diff  <- quantile(boot_diff, c(0.025, 0.975))

obs_diff
ci_diff
```
For gender, the bootstrap difference in means (Male â€“ Female) is negative. The observed difference is about â€“0.19 hours, and the 95% bootstrap confidence interval ranges from roughly â€“0.35 to â€“0.03. Because the entire interval is below zero, the bootstrap result supports that females in this dataset sleep slightly longer on average than males. The bootstrap histogram for the difference is also stable and centered around the observed value.
```{r}
# Plot: bootstrap distribution of difference in means (Male - Female)
boot_diff_df <- data.frame(diff = boot_diff)

ggplot(boot_diff_df, aes(x = diff)) +
  geom_histogram(bins = 30) +
  geom_vline(xintercept = obs_diff, linetype = "dashed") +
  labs(
    title = "Bootstrap Distribution of Mean Sleep Duration Difference (Male - Female)",
    x = "Bootstrap Difference in Means (hours)",
    y = "Frequency"
  )
```

Bootstrapping is appropriate for this phase because each person in the dataset contributes one independent observation, the dataset is large enough for resampling to be reliable, and the bootstrap sampling distributions are smooth and well-behaved. The method does not require the original variables to be normally distributed, so the conditions needed for bootstrapping are met here.


# Phase 3

In this phase, we use **permutation tests** to determine whether certain lifestyle factors  
(stress level and sleep disorders) are associated with differences in **mean sleep duration**.

A permutation test is a nonparametric hypothesis test that measures whether an observed  
difference between two groups could have occurred by random chance. Instead of relying on  
theoretical distributions (like the t-distribution), permutation tests generate a **null  
distribution** by repeatedly shuffling group labels and recalculating the statistic.

#### **Test statistic**

In both tests, the statistic is the **difference in mean sleep duration**:

\[
T = \bar{X}_{(1)} - \bar{X}_{(2)}
\]

#### **Null hypothesis**

The null hypothesis states that the group labels (e.g., low vs high stress) do not affect  
sleep duration. Formally:

\[
H_0 : \mu_1 = \mu_2
\]

The alternative hypothesis is that the groups differ:

\[
H_A : \mu_1 \neq \mu_2
\]

#### **Permutation procedure**

1. Compute the observed statistic \(T_{\text{obs}}\).  
2. Randomly shuffle the group labels (e.g., â€œLowâ€ and â€œHighâ€ stress).  
3. Recalculate the statistic under this shuffled assignment.  
4. Repeat steps 2â€“3 many times (e.g., 5000 permutations).  
5. Compute the two-sided p-value:

\[
p = \frac{\#\left(|T_{\text{perm}}| \ge |T_{\text{obs}}|\right)}{B}
\]

where \(B\) is the number of permutations.

Permutation tests are appropriate here because the observations (people) are independent,  
and the null hypothesis assumes that sleep duration is **exchangeable** between groups.  
This method does not require normality or equal variances, making it particularly well  
suited for real-world health data.



### 3.1 Permutation Test: Stress Level and Sleep Duration
 
```{r phase3-setup}
library(dplyr)
library(ggplot2)

# Create Low/High stress groups
dat <- dat |>
  mutate(stress_group = ifelse(stress_level <= 5, "Low", "High"))

# Keep only rows with both sleep_duration and stress_group
stress_df <- dat |>
  filter(!is.na(sleep_duration), !is.na(stress_group))
```


```{r phase3-stress-obs}
# Mean sleep duration in each stress group
stress_means <- stress_df |>
  group_by(stress_group) |>
  summarise(mean_sleep = mean(sleep_duration), .groups = "drop")

stress_means

# Observed difference in means: Low - High
obs_diff_stress <- with(stress_df,
                        mean(sleep_duration[stress_group == "Low"]) -
                        mean(sleep_duration[stress_group == "High"]))

obs_diff_stress
```

The observed difference in mean sleep duration is computed as:

\[
T_{\text{obs}} 
= \bar{X}_{\text{Low}} - \bar{X}_{\text{High}}
= 7.5846 - 6.5651
= 1.0196 \text{ hours}.
\]

This means that low-stress participants sleep, on average, about one hour more per night compared to high-stress participants.



```{r phase3-stress-permutation}
set.seed(3333)
B <- 5000  # number of permutations

# Permutation distribution
perm_diff_stress <- replicate(B, {
  shuffled <- sample(stress_df$stress_group)  # shuffle group labels
  mean(stress_df$sleep_duration[shuffled == "Low"]) -
    mean(stress_df$sleep_duration[shuffled == "High"])
})

# Two-sided p-value
p_stress <- mean(abs(perm_diff_stress) >= abs(obs_diff_stress))
p_stress
```
The permutation test produced a two-sided p-value of

\[
p_{\text{stress}} < 0.0002,
\]

because none of the 5000 permuted differences in means were as extreme as the observed  
difference of 1.02 hours. This indicates extremely strong evidence against the null hypothesis  
that sleep duration is the same in low- and high-stress groups.

We therefore conclude that stress level is significantly associated with sleep duration, with  
low-stress individuals sleeping about one hour more per night on average.


```{r phase3-stress-plot}
ggplot(data.frame(diff = perm_diff_stress), aes(x = diff)) +
  geom_histogram(bins = 30) +
  geom_vline(xintercept = obs_diff_stress, linetype = "dashed", color="red") +
  labs(
    title = "Permutation Test: Sleep Duration (Low vs High Stress)",
    x = "Difference in Means (hours)",
    y = "Frequency"
  )
```
The histogram shows the permutation distribution of the difference in mean sleep duration  
between the Low and High stress groups under the null hypothesis that stress has no effect  
on sleep. The distribution is centered near zero, which represents the differences we would  
expect to see purely by chance if stress and sleep duration were unrelated.

The dashed red vertical line marks the observed difference of 1.02 hours. This value lies far  
outside the range of the permutation distribution, and none of the 5000 permuted statistics  
were as extreme as the observed one. This visually confirms the very small p-value  
\((p < 0.0002)\) and provides strong evidence that stress level is associated with sleep duration.


### 3.2 Permutation Test: Sleep Disorder and Sleep Duration


```{r phase3-disorder-setup}
# Create None vs Disorder groups
dat <- dat |>
  mutate(disorder_group = ifelse(sleep_disorder == "None", "None", "Disorder"))

disorder_df <- dat |>
  filter(!is.na(sleep_duration), !is.na(disorder_group))
```


```{r phase3-disorder-obs}
# Mean sleep duration for each disorder status
disorder_means <- disorder_df |>
  group_by(disorder_group) |>
  summarise(mean_sleep = mean(sleep_duration), .groups = "drop")

disorder_means

# Observed difference: None - Disorder
obs_diff_disorder <- with(disorder_df,
                          mean(sleep_duration[disorder_group == "None"]) -
                          mean(sleep_duration[disorder_group == "Disorder"]))

obs_diff_disorder

```
The sample results show a moderate difference in average sleep duration between individuals
with and without diagnosed sleep disorders. Participants with **no sleep disorder** slept an
average of **7.36 hours**, while those with **a disorder** (insomnia or sleep apnea) slept an
average of **6.81 hours**. The observed difference in means is:

\[
T_{\text{obs}}
= \bar{X}_{\text{None}} - \bar{X}_{\text{Disorder}}
= 7.3584 - 6.8123
= 0.5462 \text{ hours}.
\]

This means that, on average, people without a sleep disorder sleep **about 0.55 hours more**
per night (approximately 33 minutes) than those with a disorder.  
However, this observed difference may still be due to random variation. To determine whether
the difference is statistically significant, we perform a permutation test in the next step.


```{r phase3-disorder-permutation}
set.seed(3333)
B <- 5000  # number of permutations

perm_diff_disorder <- replicate(B, {
  shuffled <- sample(disorder_df$disorder_group)
  mean(disorder_df$sleep_duration[shuffled == "None"]) -
    mean(disorder_df$sleep_duration[shuffled == "Disorder"])
})

# Two-sided p-value
p_disorder <- mean(abs(perm_diff_disorder) >= abs(obs_diff_disorder))
p_disorder
```
```{r phase3-disorder-plot}
ggplot(data.frame(diff = perm_diff_disorder), aes(x = diff)) +
  geom_histogram(bins = 30) +
  geom_vline(xintercept = obs_diff_disorder, linetype = "dashed", color="red") +
  labs(
    title = "Permutation Test: Sleep Duration (None vs Disorder)",
    x = "Difference in Means (hours)",
    y = "Frequency"
  )
```


### Interpretation

The permutation test produced a p-value of

\[
p_{\text{disorder}} < \frac{1}{5000} = 0.0002,
\]

because none of the 5000 permuted differences were as large as the observed difference of  
0.546 hours. This means the observed difference is far outside what we would expect by  
random chance if sleep disorders had no effect on sleep duration.

Therefore, we reject the null hypothesis and conclude that sleep duration differs  
significantly between people with and without sleep disorders. On average, individuals  
without a disorder sleep about 0.55 hours (33 minutes) more per night than those  
diagnosed with insomnia or sleep apnea.





#Phase 5: Model:Sleep Duration = Î²0 + Î²1(Stress Level) + Î²2(Physical Activity Level) + Î²3(Age) + Î²4(Gender) + Î²5(BMI Category) + Îµ
- Assess assumptions (linearity, normality of residuals, constant variance).
- Compute bootstrap confidence intervals for regression coefficients.

#Setup & clean names

```{r}

# install.packages(c("janitor","car","broom","boot")) # run once if needed
library(janitor)
library(car)
library(broom)
library(boot)

# start from your loaded data frame:
# Sleep_health_and_lifestyle_dataset  (already in your session)
dat <- clean_names(data)

# Make factors (categoricals)
dat$gender       <- factor(dat$gender)
dat$bmi_category <- factor(dat$bmi_category)
dat$sleep_disorder <- factor(dat$sleep_disorder)



```


#Weâ€™ll predict sleep_duration from stress_level, physical_activity_level, age, gender, bmi_category.

```{r}

m1 <- lm(sleep_duration ~ stress_level + physical_activity_level + age +
           gender + bmi_category,
         data = dat)

summary(m1)







```
#Model: sleep_duration ~ stress_level + physical_activity_level + age + gender + bmi_category
Fit: RÂ² = 0.832 (Adj. RÂ² = 0.829); Residual SE = 0.329 h; F(7, 366) = 259.6, p < 2e-16.
Interpretation: The model explains ~83% of the variance in sleep duration. Stress is the dominant predictor; activity, age, gender, and BMI also matter.


#Check assumptions

```{r}
#check linearity, homoscedasticity, leverage
par(mfrow=c(2,2)); plot(m1); par(mfrow=c(1,1))  # residuals, QQ, scale-location, leverage
car::vif(m1)  # multicollinearity check (aim <~ 5)

#Check the normality of residuals

hist(residuals(m1), breaks=20, main="Histogram of residuals", xlab="Residuals")
qqnorm(residuals(m1)); qqline(residuals(m1), col="red")




```

#Interpretation: All major regression assumptions were examined to ensure the validity of inference. The Residuals vs Fitted and Scale-Location plots showed a roughly random scatter of residuals around zero, with slight curvature and a mild increase in variance, suggesting only minor nonlinearity and  heteroskedasticity . The Qâ€“Q plot indicated that residuals follow the theoretical normal line closely, with small deviations in the tails.

The Variance Inflation Factors (VIFs) for all predictors were below 3, confirming that multicollinearity is not a concern. The Shapiroâ€“Wilk test and visual inspection supported that residuals are approximately normally distributed, which is sufficient for valid inference given the large sample size (
ð‘›
=
374
n=374). Even if residuals deviate slightly from perfect normality, the Central Limit Theorem ensures that coefficient estimates remain unbiased and normally distributed in large samples.

To account for minor violations, the analysis also reports heteroskedasticity-robust (HC3) standard errors and bootstrap confidence intervals, which do not rely on strict normality assumptions. Overall, the diagnostic results indicate that model assumptions are reasonably satisfied, and the regression model provides reliable and interpretable estimates.


#Formal tests + robust (HC3) SEs

```{r}

library(lmtest)
library(sandwich)

# Breuschâ€“Pagan test for heteroskedasticity
bptest(m1)

# Robust (HC3) standard errors and p-values
coeftest(m1, vcov = vcovHC(m1, type = "HC3"))



```
#The Breuschâ€“Pagan test detected heteroskedasticity (BP = 76.87, df = 7, p < 6.0Ã—10â»Â¹â´), indicating non-constant error variance. To protect inference, coefficient tests were recomputed with heteroskedasticity-robust (HC3) standard errors. The robust results closely mirror the OLS results and do not change any substantive conclusions:

Stress level remains a large, highly significant negative predictor (Î² = âˆ’0.302 h per unit; p < 2Ã—10â»Â¹â¶).

Physical activity level stays a small but significant positive predictor (Î² â‰ˆ +0.0057 h per unit; p = 5.23Ã—10â»Â¹Â²).

Age remains positively associated with sleep (Î² â‰ˆ +0.0356 h/year; p < 2Ã—10â»Â¹â¶).

Gender (Male) continues to predict longer sleep (Î² â‰ˆ +0.388 h; p < 2Ã—10â»Â¹â¶).

BMI categories: Overweight (Î² â‰ˆ âˆ’0.647 h; p < 2Ã—10â»Â¹â¶) and Obese (Î² â‰ˆ âˆ’0.317 h; p = 0.0024) sleep less than the reference BMI group, while Normal Weight is not statistically different (p = 0.221).


#Cook distance: Sensitivity analysis for influential points
```{r}
# Cook's distance
cd <- cooks.distance(m1)
thr <- 4 / nrow(dat)   # common rule of thumb
which(cd > thr)

# Refit without influential points (if any)
keep <- cd <= thr
m1_sens <- lm(sleep_duration ~ stress_level + physical_activity_level + age +
                gender + bmi_category, data = dat[keep, ])

summary(m1)$coef[,1]      # original betas
summary(m1_sens)$coef[,1] # betas after removing influential points



```
#Influence and sensitivity. Observations with large influence were identified using Cookâ€™s distance (threshold 4/n), flagging cases 33, 146, 185, 186, 265, 267, 277, 278, 342, and 343. Re-estimating the model after excluding these observations produced coefficients that were highly consistent with the full-sample estimates: the effects of stress (â‰ˆ âˆ’0.30 h per unit), physical activity (â‰ˆ +0.006 h per unit), age (â‰ˆ +0.036â€“0.039 h per year), and male gender (â‰ˆ +0.39â€“0.44 h) changed only trivially. The negative association for the Overweight BMI category remained large and stable, while the Obese coefficient attenuated (â‰ˆ âˆ’0.32 h to âˆ’0.16 h), indicating some sensitivity of that specific effect to influential points. Overall, the substantive conclusions are robust to the removal of high-influence observations.

#Bootstrap confidence intervals for coefficients

```{r}
set.seed(123)
library(boot)

boot_fun <- function(data, idx){
  d <- data[idx, ]
  coef(lm(sleep_duration ~ stress_level + physical_activity_level + age +
            gender + bmi_category, data = d))
}

B <- 5000
boot_fit <- boot(dat, boot_fun, R = B)

# Build a tidy dataframe of percentile CIs
boot_ci <- lapply(seq_along(boot_fit$t0), function(j){
  ci <- boot.ci(boot_fit, type="perc", index=j)$percent[4:5]
  data.frame(term = names(boot_fit$t0)[j],
             estimate = boot_fit$t0[j],
             conf_low = ci[1],
             conf_high = ci[2])
})
boot_ci <- do.call(rbind, boot_ci)
boot_ci




```

Interpretation: Using nonparametric bootstrapping (R = 5000, percentile method), we obtained 95% confidence intervals for all coefficients. The intervals for stress level, physical activity, age, male gender, BMIâ€“Obese, and BMIâ€“Overweight did not include zero, confirming statistically significant associations in the same directions as the OLS/HC3 results. In practical terms, higher stress was associated with substantially less sleep (~18 minutes per one-unit increase), while higher physical activity and older age were associated with more sleep (smallâ€“moderate magnitudes). Males slept ~23 minutes longer than females. Relative to the reference BMI group, Overweight participants slept ~39 minutes less and Obese ~19 minutes less, whereas Normal Weight did not differ significantly (CI crosses zero). These bootstrap results reinforce the robustness of our conclusions despite mild departures from normality and heteroskedasticity.


# Phase 4 â€” Correlation Analysis

```{r}
library(janitor)
library(dplyr)
library(ggplot2)
library(GGally)
library(ggcorrplot) 

 data <- read.csv("sleep_health_and_lifestyle_dataset.csv")

# clean names
dat <- clean_names(data)

# Convert categorical variables
dat <- dat %>%
  mutate(
    gender = factor(gender),
    bmi_category = factor(bmi_category),
    sleep_disorder = factor(sleep_disorder)
  )

# Select numeric variables for correlation
num_vars <- c("sleep_duration","quality_of_sleep","stress_level",
              "physical_activity_level","age","heart_rate","daily_steps")

nums <- dat %>%
  select(all_of(num_vars)) %>%
  mutate(across(everything(), as.numeric))

```

```{r}
cor_mat <- cor(nums, use="pairwise.complete.obs", method="pearson")
round(cor_mat, 2)
```

```{r}
cor_pmat <- function(df){
  n <- ncol(df); P <- matrix(NA, n, n); diag(P) <- 0
  for(i in 1:n) for(j in i:n){
    ct <- suppressWarnings(cor.test(df[[i]], df[[j]], use="pairwise.complete.obs"))
    P[i,j] <- P[j,i] <- ct$p.value
  }
  colnames(P) <- colnames(df); rownames(P) <- colnames(df); P
}
p_mat <- cor_pmat(nums)
ggcorrplot(cor_mat, type="lower", lab=TRUE, p.mat=p_mat, insig="blank") +
  labs(title="Correlation heatmap (numeric variables)")
```

```{r}
key_vars <- c("sleep_duration","quality_of_sleep","stress_level",
              "physical_activity_level","age","heart_rate")
GGally::ggpairs(dat, columns = key_vars, aes(color = gender, alpha = 0.7), progress=FALSE)
```

```{r}
to_num01 <- function(f) as.numeric(f) - 1
pb_gender_sleepdur   <- suppressWarnings(cor(nums$sleep_duration, to_num01(dat$gender), use="pairwise.complete.obs"))
pb_gender_sleepqual  <- suppressWarnings(cor(nums$quality_of_sleep, to_num01(dat$gender), use="pairwise.complete.obs"))
pb_dis_sleepdur      <- suppressWarnings(cor(nums$sleep_duration, to_num01(dat$sleep_disorder), use="pairwise.complete.obs"))
pb_dis_sleepqual     <- suppressWarnings(cor(nums$quality_of_sleep, to_num01(dat$sleep_disorder), use="pairwise.complete.obs"))

eta_sq <- function(y, g){ an <- anova(lm(y ~ g)); an$`Sum Sq`[1] / sum(an$`Sum Sq`) }
eta_sleepdur_bmi  <- eta_sq(dat$sleep_duration, dat$bmi_category)
eta_sleepqual_bmi <- eta_sq(dat$quality_of_sleep, dat$bmi_category)

data.frame(
  metric = c("sleep_duration ~ gender (r_pb)","quality_of_sleep ~ gender (r_pb)",
             "sleep_duration ~ sleep_disorder (r_pb)","quality_of_sleep ~ sleep_disorder (r_pb)",
             "sleep_duration ~ bmi_category (eta^2)","quality_of_sleep ~ bmi_category (eta^2)"),
  value  = round(c(pb_gender_sleepdur, pb_gender_sleepqual, pb_dis_sleepdur, pb_dis_sleepqual,
                   eta_sleepdur_bmi, eta_sleepqual_bmi), 3)
)
```

```{r}
pairs <- t(combn(colnames(nums), 2))
sig_tbl <- apply(pairs, 1, function(ix){
  a <- ix[1]; b <- ix[2]
  out <- suppressWarnings(cor.test(nums[[a]], nums[[b]], use="pairwise.complete.obs"))
  c(var1=a, var2=b, r=unname(out$estimate), p=out$p.value)
})
sig_tbl <- as.data.frame(t(sig_tbl))
sig_tbl$r <- round(as.numeric(sig_tbl$r), 3)
sig_tbl$p <- p.adjust(as.numeric(sig_tbl$p), method="holm")
sig_tbl$p <- round(sig_tbl$p, 4)
sig_tbl[order(sig_tbl$p), ]
```



**Conclusion (Phase 4).**  
- Stress shows a negative association with sleep (duration & quality); physical activity shows a positive association.  
- Several pairs are statistically significant after Holm adjustment (see table).  
- Gender/sleep-disorder show meaningful point-biserial links; BMI category explains a non-trivial fraction of variance (Î·Â²).  
- These patterns motivate the Phase 5 regression with stress + activity + demographics.
